services:
  {{CONTAINER_NAME}}:
    build: .
    container_name: "{{CONTAINER_NAME}}"
    hostname: "{{CONTAINER_NAME}}"
    
    # Working directory inside container - now under /app
    working_dir: /app/private
    
    # Volume mounts - now using /app prefix to avoid root conflicts
    volumes:
      - "{{PRIVATE_VOLUME}}:/app/private"
      - shared_data:/app/shared:ro  # Read-only for shared data
    
    restart: unless-stopped
    
    environment:
      - CONTAINER_NAME={{CONTAINER_NAME}}
      - TAGS={{TAGS}}
      - PRIVATE_DATA_PATH=/app/private
      - SHARED_DATA_PATH=/app/shared
    
    labels:
      - "user.name={{CONTAINER_NAME}}"
      - "user.tags={{TAGS}}"

    
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M
    
    networks:
      - user_network 
    
    # Uncomment ports as needed:
    # ports:
    #   - "8080:8080"
    #   - "5432:5432"
    
    # Health check
    healthcheck:
      test: ["CMD-SHELL", "test -d /app/private && test -d /app/shared"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

################################################################################
# Networks
################################################################################
networks:
  user_network:
    external: true
    name: user_shared_network

################################################################################
# Volumes
################################################################################
volumes:
  {{PRIVATE_VOLUME}}:
    external: true
  
  shared_data:
    external: true